<!DOCTYPE html>
<html>
<head>
<title>SSH Cert</title>
<meta http-equiv="content-security-policy" content="default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline';" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/.sso/favicon.ico" />
<link rel="stylesheet" type="text/css" href="/.sso/style.css" />
<script>
let filename = 'XXXXXXX';
function onClick() {
  let body = document.getElementById('key').value;
  const ttl = document.getElementById('ttl');
  const ttlValue = ttl.options[ttl.selectedIndex].value;
  if (ttlValue !== '') {
    body += '\nttl=' + encodeURIComponent(ttlValue);
  }
  fetch(window.location, {
    method: 'POST',
    headers: {
      'x-csrf-check': 1,
      'content-type': 'text/plain',
    },
    body: body,
  })
  .then(resp => {
    if (resp.status !== 200) {
      resp.text().then(t => {
        document.getElementById('certdiv').style.display = 'none';
        const err = document.getElementById('err');
        err.textContent = resp.status + ': ' + t;
        err.style.display = 'block';
      });
      throw resp.status;
    }
    return resp.text();
  })
  .then(cert => {
    document.getElementById('err').style.display = 'none';
    document.getElementById('cert').textContent = cert;
    const download = document.getElementById('download');
    download.href = 'data:text/plain;base64,'+window.btoa(cert);
    download.setAttribute('download', filename + '-cert.pub');
    document.getElementById('certdiv').style.display = 'block';
  })
  .catch(e => console.log('ERR:', e));
}
function pickFile() {
  document.getElementById('filepicker').click();
}
function receiveFile(elem) {
  if (elem.files.length === 1) {
    elem.files[0].text().then(t => document.getElementById('key').value = t);
    filename = elem.files[0].name.replace('-cert.pub', '').replace('.pub', '');
  }
}
</script>
</head>
<body>
{{ if ne .Email "" }}
<div style="position: absolute; right: 1rem; top: 1rem;">
{{.Email}} <a href="/.sso/logout" class="button">Logout</a>
</div>
{{ end }}
<div id="message" style="text-align: left;">
<p>Enter or upload your SSH <em>Public</em> Key to receive a Certificate with principal: [<b>{{.Email}}</b>] signed by <b>{{.Name}}</b>.</p>
<p>To trust this Certificate Authority, add this line to your <code>$HOME/.ssh/authorized_keys</code> file.</p>
<div style="margin: 1rem; word-break: break-all; user-select: all; padding: 0.5em; border: 1px solid black;">
cert-authority,principals="{{.Email}}" {{.CA}}
</div>
<input id="filepicker" type="file" accept=".pub" style="opacity: 0;" onchange="receiveFile(this);"><br />
<label for="ttl">Expiration:</label><select id="ttl">
<option value="300">5 min</option>
<option value="600">10 min</option>
<option value="1800">30 min</option>
<option value="3600" selected>1 hour</option>
<option value="21600">6 hours</option>
<option value="43200">12 hours</option>
<option value="86400">24 hours</option>
</select><br />
<textarea id="key" style="height: 5em; width: 75vw;" placeholder="SSH Public Key"></textarea>
<a class="button" onclick="pickFile();">Upload Public Key</a>
<a class="button" onclick="onClick();">Get Certificate</a>
<div id="err" style="display: none; margin: 1em;"></div>
<div id="certdiv" style="display: none; margin: 1em;">
Certificate:
<div id="cert" style="margin: 1rem; word-break: break-all; user-select: all; padding: 0.5em; border: 1px solid black;"></div>
<a id="download" class="button">Download â¤“</a>
</div>
</div>
</body>
</html>
